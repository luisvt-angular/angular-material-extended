<ng-template #headerColumns let-auxColumns>
  <!-- auxColumns: MatxColumnDirective[] -->
  <div class="mat-header-cell" *ngFor="let column of auxColumns" [ngClass]="column.ngClass" [ngStyle]="column.ngStyle">
    <div (click)="_sort(column)">
      <ng-template [ngIf]="!column.headerTemplate">{{column.header}}</ng-template>
      <ng-template [ngTemplateOutlet]="column.headerTemplate"></ng-template>
    </div>
    <mat-icon *ngIf="column.sortable && column.sortDirection === 1">north</mat-icon>
    <mat-icon *ngIf="column.sortable && column.sortDirection === -1">south</mat-icon>
  </div>
</ng-template>

<ng-template #bodyColumns let-auxColumns let-row="row" let-form="form">
  <!-- auxColumns: MatxColumnDirective[] -->
  <!-- row: MatxRow -->
  <!-- form: NgForm -->
  <div class="mat-cell" *ngFor="let column of auxColumns" [ngClass]="column.ngClass" [ngStyle]="column.ngStyle">
    <ng-template [ngIf]="!editable || !column.editorTemplate || !row.editing" [ngIfElse]="columnEditor">
      <ng-template [ngIf]="!column.cellTemplate">{{get(row.item, column.field)}}</ng-template>
      <ng-template [ngTemplateOutlet]="column.cellTemplate" [ngTemplateOutletContext]="{$implicit: row.item, row: row, form: form}"></ng-template>
    </ng-template>
    <ng-template #columnEditor>
      <ng-template [ngTemplateOutlet]="column.editorTemplate" [ngTemplateOutletContext]="{$implicit: row.item, row: row, form: form}"></ng-template>
    </ng-template>
  </div>
</ng-template>


<div class="matx-table-container mat-table" [ngStyle]="contentStyle">
  <div class="mat-header-row" mat-header-row>
    <div class="matx-table-frozen-left" *ngIf="selectable || detailRow || frozenLeftColumns.length" [ngStyle]="frozenLeftStyle">
      <div class="mat-header-cell matx-cell-expander" *ngIf="detailRow"></div>
      <div class="mat-header-cell matx-cell-select" *ngIf="selectable">
        <mat-checkbox [checked]="allSelected || someSelected" [indeterminate]="someSelected" (change)="toggleSelectAll($event)"></mat-checkbox>
      </div>
      <ng-template [ngTemplateOutlet]="headerColumns" [ngTemplateOutletContext]="{$implicit: frozenLeftColumns}"></ng-template>
    </div>
    <div class="matx-scrollable-columns">
      <ng-template [ngTemplateOutlet]="headerColumns" [ngTemplateOutletContext]="{$implicit: scrollableColumns}"></ng-template>
    </div>
    <div class="matx-table-frozen-right" *ngIf="frozenRightColumns.length" [ngStyle]="frozenRightStyle">
      <ng-template [ngTemplateOutlet]="headerColumns" [ngTemplateOutletContext]="{$implicit: frozenRightColumns}"></ng-template>
    </div>
  </div>

  <ng-template ngFor let-row [ngForOf]="rows">
    <form #form="ngForm" class="mat-row" mat-row (dblclick)="startEditing(row, form)" (submit)="submitRow(row, form)"
          (keyup.escape)="resetRow(row, form)">
      <button type="submit" hidden></button>
      <div class="matx-table-frozen-left" *ngIf="selectable || detailRow || frozenLeftColumns.length" [ngStyle]="frozenLeftStyle">
        <div class="mat-cell matx-cell-expander" *ngIf="detailRow">
          <button mat-icon-button type="button" (click)="row.expanded = !row.expanded">
            <mat-icon *ngIf="!row.expanded">keyboard_arrow_right</mat-icon>
            <mat-icon *ngIf="!!row.expanded">keyboard_arrow_down</mat-icon>
          </button>
        </div>
        <div class="mat-cell matx-cell-select" *ngIf="selectable">
          <mat-checkbox [checked]="isRowSelected(row)" (change)="toggleSelectRow(row, $event)"></mat-checkbox>
        </div>
        <ng-template [ngTemplateOutlet]="bodyColumns" [ngTemplateOutletContext]="{$implicit: frozenLeftColumns, row: row, form: form}"></ng-template>
      </div>
      <div class="matx-scrollable-columns">
        <ng-template [ngTemplateOutlet]="bodyColumns" [ngTemplateOutletContext]="{$implicit: scrollableColumns, row: row, form: form}"></ng-template>
      </div>
      <div class="matx-table-frozen-right" *ngIf="frozenRightColumns.length" [ngStyle]="frozenRightStyle">
        <ng-template [ngTemplateOutlet]="bodyColumns" [ngTemplateOutletContext]="{$implicit: frozenRightColumns, row: row, form: form}"></ng-template>
      </div>
    </form>
    <div class="mat-detail-row" *ngIf="detailRow && row.expanded">
      <ng-template [ngTemplateOutlet]="detailRow" [ngTemplateOutletContext]="{$implicit: row.item}"></ng-template>
    </div>
  </ng-template>
</div>

<div *ngIf="printing" #printable hidden>
  <table class="mat-table">
    <tr class="mat-header-row">
      <ng-template ngFor let-column [ngForOf]="columns">
        <th *ngIf="!column.noPrintable" class="mat-header-cell">
          <ng-template [ngIf]="!column.headerTemplate">{{column.header}}</ng-template>
          <ng-template [ngTemplateOutlet]="column.headerTemplate"></ng-template>
        </th>
      </ng-template>
    </tr>
    <tr *ngFor="let row of rows" class="mat-row">
      <ng-template ngFor let-column [ngForOf]="columns">
        <td *ngIf="!column.noPrintable" class="mat-cell">
          <ng-template [ngIf]="!column.cellTemplate">{{get(row.item, column.field)}}</ng-template>
          <ng-template [ngTemplateOutlet]="column.cellTemplate"
                       [ngTemplateOutletContext]="{$implicit: row.item, row: row}"></ng-template>
        </td>
      </ng-template>
    </tr>
  </table>
</div>
